<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<style>

    body {

        font: normal 15px/100% "Segoe UI", Verdana, Tahoma, sans-serif;
        color: blue;
        font-size: 18px;
        line-height: 1.4em;
        text-align: left;
        margin: 0;
        padding: 0 8px 5px 8px;


    }


    .titolo-iniziale {
        text-align: center;
        margin-bottom: 20px;
    }

    .control-panel{

        box-sizing: border-box;
        padding: 0;

        margin: 0;

        display: -webkit-box;

        display: -moz-box;

        display: -ms-flexbox;

        display: -webkit-flex;

        display: flex;

        flex-direction: row;
        flex-wrap: wrap;

        gap: 20px;


        width: 100%;

    }


    .control-panel button {

        display: flex;


        flex-direction: column;

        align-items: center;

        justify-content: center;

        width: 80px;        /* larghezza bottone */

        height: 80px;       /* altezza bottone */

        margin: 8px;

        border: 1px solid #ccc;

        border-radius: 6px;
        box-sizing : border-box;

        background: white;

        cursor: pointer;

        padding: 8px;

        font: normal 13px/100% Verdana, Tahoma, sans-serif; color: #2539b4;

    }

    .control-panel button.selected {
        background-color: #27d4da;
    }

    #clearBtn.selected {
        background-color: #27d4da;
    }
    .btn-icon {

        width: 10px; /*icona quadrata */

        height: 10px;

        display:flex;

        align-items:center;

        justify-content: center;

        font-size: 32px;   /* dimensione icona font */

        color: #333;

        border-radius: 6px;

        box-sizing: border-box;

        align-content: space-around;

    }
    .btn-label {
        margin-bottom: 18px;
        font-size: 14px;
        padding-bottom: 8px;
        margin: 1px;
    }

    #preview-box {
        width: 100%;
        height: 45px; /* altezza fissa */
        border: 2px solid #555;
        border-radius: 8px;
        /*padding: 5px;*/
        padding: 0 15px;
        box-sizing: border-box;
        background-color: transparent;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding-right: 8px;
        padding-left: 8px;
    }
    #previewLine {
        max-width: 100%;
        max-height: 100%; /* valore di default */
        border-radius: 4px;
        background-color: #bd3c4b;
        transition: background-color 0.3s ease, border-style 0.3s ease;
        /*padding-right: 10px;
         padding-left: 10px;*/

    }

    .line-and-button{
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .line-and-button button {

        background-color: white;


    }



    #clearPreviewBtn.selected  {
        background-color: #27d4da;

        color: white;
        border-color: #388e3c;
    }

    .tool-section{
        max-width: 400px;
        display : flex;
        flex-direction: column;
        padding-left: 0px;
        padding-right: 0px;
        text-align: center;
        padding-right: 8px;
        padding-left: 8px;
    }

    #clearPreviewBtn{
        transition: background-color 0.3s ease;
        color: red;
        background-color: white ;

        /* #clearPreviewBtn{*/
        width: 80px;
        height: 80px;
        /* margin-top:20px;*/
        padding:2px 2px;
        border-radius: 6px;
        flex-shrink: 0;

    }
    h3 {

        text-align: center;

    }
    .text{
        display:flex;
        /*align-items: left;*/
        gap: 10px;
        /*padding-left: 10px;*/
    }


    #measurement-text, #font-color, #font-size, #colorPicker, #styleSelect, #transparencyRange,
    #lineWidth, #labelText, #fontColor, #fontSize, #areaUnits, #distanceUnits, #distanceUnits, #areaUnits,
    #fontFamily {
        border-radius: 6px;
    }
    .colore-font, .dimensione-font,
    .font-family, .testo-misurazione  {
        display:flex;

    }

    .testo-misurazione{

        gap: 20px;

    }

    .colore-font{

        gap: 20px;

    }

    .dimensione-font{

        gap:20px;

    }

    .font-family{

        gap: 20px;

    }
    .font-size{
        display:flex;
        /*align-items: center;*/
        gap: 10px;
        padding-left: 0px;
    }

    .line-and-color {

        padding-right: 10px;

        padding-left: 10px;

        display: flex;

        flex-direction: column;

        gap: 10px;

    }
    .line-and-color label {

        text-align: left;

    }

    .color-line{
        text-align:left;
        margin: 0;
        display:flex;
        gap: 10px;
        max-width: 100%;
        padding-bottom: 8px;
    }

    .line-style{
        display: flex;
        gap: 10px;
    }



    .line-transparency{
        max-width: 100px;
        display: flex;
        gap: 8px;

    }

    .spessore-linea{
        display:flex;
        gap:10px;

    }

    #styleSelect {
        max-width: 100px;
        /*max-width: 100%; */
        height: 30px;
        gap:9px;
    }

    .line-and-save {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }



    .line-and-save button {
        /* transition: background-color 0.3s ease;*/
        color: red;
        background-color: white ;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing : border-box;
        width: 80px;
        height: 80px;
        /* margin-top:20px;*/
        padding:2px 2px;
        border-radius: 6px;
        cursor: pointer;

    }

    .line-and-save button.selected {
        background-color: #27d4da;
        color: white;
        border-color: #388e3c;

    }


    .btn-icon-save {
        width: 10px; /*icona quadrata */
        height: 10px;
        font-size: 32px;
        color: #333;

        border-radius: 6px;

        box-sizing: border-box;

        align-content: space-around;
    }
    .font-and-load {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .font-and-load button{
        color: red;
        background-color: white;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        width: 80px;
        height: 80px;
        padding: 2px 2px;
        border-radius: 6px;
        /*border: 2px solid #ccc;
        cursor: pointer;
    }

    .font-and-load button.selected{
        background-color: #27d4da;
        color: white;
        border-color: #388e3c !important;
        transform: scale(0.98) !important; /* Effetto click */
    }
    .btn-icon-load{
        width: 10px; /*icona quadrata */
        height: 10px;
        font-size: 32px;
        color: #333;

        border-radius: 6px;

        box-sizing: border-box;

        align-content: space-around;

    }





</style>

<body>
<div class="titolo-iniziale">
    <h2>Seleziona strumento di misura</h2>
</div>
<div class="control-panel">


    <button data-tool="polyline" title="Linea e Polilinea">
        <span class="btn-label">Polyline</span>
        <br>
        <span class="btn-icon"><i class="fas fa-chart-line"></i></span>

    </button>

    <button data-tool="polygon" title="Poligono">
        <span class="btn-label">Polygon</span>
        <br>
        <span class="btn-icon"><i class="fa-solid fa-draw-polygon" style="color: #74C0FC;"></i></span>
    </button>
    <button data-tool="rectangle" title="Rettangolo">
        <span class="btn-label">Rectangle Square</span>
        <span class="btn-icon"><i class="fas fa-square" style="color: #74C0FC;"></i></span>
    </button>
    <button data-tool="circle" title="Cerchio">
        <span class="btn-label">Circle</span>
        <br>
        <span class="btn-icon"><i class="fa-regular fa-circle fa-lg" style="color: #B197FC;"></i></span>
    </button>

    <button data-tool="freetext" title="Testo libero">
        <span class="btn-label">Insert text</span>
        <span class="btn-icon"><i class="fa-solid fa-a"  style="color: #202427;"></i></span>
    </button>

    <button id="clearBtn" title="Cancella ">
        <span class="btn-label">Cancel</span>
        <br>
        <span class="btn-icon"><i class="fas fa-trash-alt" style="color:#B197FC;"></i></span>
    </button>
</div>

<br>
<div class="tool-section">
    <h3>Preview</h3>
    <div class="preview-box" id="preview-box">
        <br>
        <div id="previewLine">

        </div>
    </div>
</div>
<br>
<div class="line-and-color">
    <br>

    <div  class =" line-and-button">
        <div class="color-line">
            <label for="colorPicker">Colore linea</label>
            <input type="color" id="colorPicker"  />
        </div>
        <div class="buttonclearPreview">
            <button id="clearPreviewBtn" title="Clear Preview" >
                Cancella Preview
            </button>
        </div>
    </div>
    <div class="line-style">
        <label for="styleSelect">Stile linea</label>
        <select id="styleSelect">
            <option value="solid">Continua</option>
            <option value="dashed">Tratteggiata</option>
            <option value="dotted">Puntinata</option>
        </select>
    </div>
    <div class="line-and-save">
        <div class="line-transparency">
            <label for="transparencyRange">Trasparenza linea</label>
            <input type="range" id="transparencyRange" min="0" max="100" value="0" />
        </div>
        <div class="buttonSave">
            <button id="saveBtn" title="Save date">
                <span class="btn-label">Salva dati</span>
                <span class="btn-icon-save"><i class="fa-solid fa-floppy-disk" style="color: #74C0FC;"></i></span>
            </button>
        </div>
    </div>

    <div class="spessore-linea">
        <label for="lineWidth">Spessore linea (px)</label>
        <input type="number" id="lineWidth" min="1" max="10" value="3" />
    </div>


    <div class="font-and-load">
        <div class="font-family">
            <label for="fontFamily">Font:</label>
            <select id="fontFamily">
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Verdana', sans-serif">Verdana</option>
            </select>
        </div>
        <div class="buttonLoad">
            <button id="loadBtn" title="Load data">
                <span class="btn-label">Load data</span>
                <span class="btn-icon-load"><i class="fa-solid fa-upload" style="color: #74C0FC;"></i></span>
            </button>
        </div>
    </div>
    <div class="colore-font">
        <label for="fontColor">Colore font</label>
        <input type="color" id="fontColor" value="#000000" />
    </div>

    <div class="dimensione-font">
        <label for="fontSize">Dimensione font (px)</label>
        <input type="number" id="fontSize" min="8" max="40" value="20" />
    </div>




</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    $(document).ready(function() {




        let selectedTool = 'line';
// Gestione click
        $('.control-panel button[data-tool]').click(function() {

            const $btn = $(this);
            const tool = $btn.data('tool')


            if ($btn.hasClass('selected')) {
                $btn.removeClass('selected');
                selectedTool = null;
                console.log('Deselezionato tool:', tool);
            } else {
                $('.control-panel button[data-tool] ').removeClass('selected');
                $('#clearBtn').removeClass('selected');
                $btn.addClass('selected');
                selectedTool = tool;
                console.log('Selezionato tool:', tool);
            }
            sendToolSelection();
        });

        $('#clearBtn').click(function() {

            const $btn = $(this);
            const tool = 'delete';

            if ($btn.hasClass('selected')) {
                $btn.removeClass('selected');
                selectedTool = null;
                console.log('Deselezionata modalita CANCELLA');

                // Aggiorna
                $('.control-panel button[data-tool]').removeClass('selected');

            } else {

                $('.control-panel button[data-tool], #clearBtn').removeClass('selected');
                $btn.addClass('selected');
                selectedTool = tool;
                //selectedTool = $btn.data('tool');
                console.log('Selezionata modalita CANCELLA');


            }
            sendToolSelection();
        });
        // Funzione per aggiornare la preview
        function updatePreview() {
            const color = $('#colorPicker').val();
            const style = $('#styleSelect').val();
            const transparency = $('#transparencyRange').val();
            const width = $('#lineWidth').val();

            console.log('Aggiorno preview con:', { color, style, transparency, width });


            const r = parseInt(color.slice(1,3),16);
            const g = parseInt(color.slice(3,5),16);
            const b = parseInt(color.slice(5,7),16);
            const a = (100 - transparency) / 100;

            const rgba = `rgba(${r},${g},${b},${a})`;

            // stile CSS della linea di preview
            let borderStyle = 'none';
            if (style === 'solid') borderStyle = `${width}px solid ${rgba}`;
            else if (style === 'dashed') borderStyle = `${width}px dashed ${rgba}`;
            else if (style === 'dotted') borderStyle = `${width}px dotted ${rgba}`;



            if (style === 'solid') {
                $('#previewLine').css({
                    'height': width + 'px',
                    'background-color': rgba,
                    'border-top': borderStyle,
                    'border-radius': '4px'
                });
            } else {
                $('#previewLine').css({
                    'height': width + 'px',
                    'background-color': 'transparent',
                    'border-top': borderStyle,
                    'border-radius': '4px'
                });
            }

        }


        function sendToolSelection() {
            const data = {
                tool: selectedTool,
                color: $('#colorPicker').val(),
                style: $('#styleSelect').val(),
                transparency: $('#transparencyRange').val(),
                width: parseInt($('#lineWidth').val(), 10),

                //labelText : $('#labelText').val(),
                fontColor : $('#fontColor').val(),
                fontSize : $('#fontSize').val(),
                fontFamily : $('#fontFamily').val()
            };

            console.log('sendToolSelection invio dati:', data);
            // Invio evento CSBL al widget mappa
            parent.$('body').trigger({
                type: "showExternalContentFromExternalContent_ExternalContent_4623_widgetExternalContent42709",
                eventGenerator: $(this),
                targetWidget: "ExternalContent_4623_widgetExternalContent42709",
                events: 'sendContent',
                passedData: data
            });

            console.log('Invio evento toolSelection_event con dati:', data);

        }
//BOTTONE SAVE PER SALVARE DATI
        $('#saveBtn').click(function() {
            console.log('Pulsante salva cliccato');

            const saveData = {
                action: 'save',  //
                tool: 'save',    //
                timestamp: new Date().toISOString()
            };

            console.log('Invio dati salvataggio:', saveData);


            parent.$('body').trigger({
                type: "showExternalContentFromExternalContent_ExternalContent_4623_widgetExternalContent42709",
                eventGenerator: $(this),
                targetWidget: "ExternalContent_4623_widgetExternalContent42709",
                events: 'sendContent',
                passedData: saveData
            });
        });

//Funzione per il bottone load

        $('#loadBtn').click(function() {
            console.log('Pulsante load cliccato');

            // Crea un input file temporaneo
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';

            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        console.log('File JSON caricato:', jsonData);

                        // Prepara i dati per il trigger
                        const loadData = {
                            action: 'load',
                            tool: 'load',
                            timestamp: new Date().toISOString(),
                            data: jsonData
                        };

                        // Trigger dell'evento secondo le specifiche Snap4City
                        parent.$('body').trigger({
                            type: "showExternalContentFromExternalContent_ExternalContent_4623_widgetExternalContent42709",
                            eventGenerator: $(this),
                            targetWidget: "ExternalContent_4623_widgetExternalContent42709",
                            events: 'sendContent',
                            passedData: loadData
                        });



                    } catch (error) {
                        console.error('Errore nel caricamento del file:', error);
                        alert('Errore nel caricamento del file JSON');
                    }
                };

                reader.readAsText(file);
            };

            fileInput.click();
        });

        // Aggiorna la preview
        $('#colorPicker, #styleSelect, #transparencyRange, #lineWidth, #labelText').on('input change', function() {

            console.log('Input/Select modificato:', this.id, $(this).val());
            updatePreview();
            sendToolSelection();
        });

        // botton clear Preview
        $('#clearPreviewBtn').click(function() {
            const $btn = $(this);
            $btn.addClass('selected');

            // Riporta i valori a default
            $('#colorPicker').val('#cc0707');
            $('#styleSelect').val('solid');
            $('#transparencyRange').val(0);
            $('#lineWidth').val(3);

            //RESETTA ANCHE IL TESTO
            $('#fontColor').val('#000000');
            $('#fontSize').val(20);
            $('#fontFamily').val('Arial, sans-serif');  //
            //riporta i valori di default
            updatePreview();

            setTimeout(() => {
                $btn.removeClass('selected');
            }, 300);

        });


        updatePreview();

    });


</script>
</body>

